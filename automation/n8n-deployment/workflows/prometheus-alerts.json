{
  "name": "Prometheus Alerts to Discord",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "prometheus-alerts",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Prometheus Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "prometheus-alerts"
    },
    {
      "parameters": {
        "jsCode": "// Parse Prometheus Alertmanager payload\nconst alerts = $input.first().json.alerts || [];\nconst results = [];\n\nfor (const alert of alerts) {\n  const status = alert.status; // firing or resolved\n  const severity = alert.labels?.severity || 'unknown';\n  const alertname = alert.labels?.alertname || 'Unknown Alert';\n  const instance = alert.labels?.instance || 'N/A';\n  const job = alert.labels?.job || 'N/A';\n  const description = alert.annotations?.description || alert.annotations?.summary || 'No description';\n  const grafanaUrl = alert.generatorURL || '';\n  \n  // Color based on status/severity\n  let color = 16776960; // yellow default\n  if (status === 'resolved') {\n    color = 65280; // green\n  } else if (severity === 'critical') {\n    color = 16711680; // red\n  } else if (severity === 'warning') {\n    color = 16744448; // orange\n  }\n  \n  // Emoji based on status\n  const emoji = status === 'resolved' ? 'âœ…' : (severity === 'critical' ? 'ðŸš¨' : 'âš ï¸');\n  \n  results.push({\n    json: {\n      status,\n      severity,\n      alertname,\n      instance,\n      job,\n      description,\n      grafanaUrl,\n      color,\n      emoji,\n      timestamp: new Date().toISOString()\n    }\n  });\n}\n\nreturn results.length > 0 ? results : [{ json: { skip: true } }];"
      },
      "id": "parse-alerts",
      "name": "Parse Alerts",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [470, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.skip }}",
              "value2": true,
              "operation": "notEqual"
            }
          ]
        }
      },
      "id": "filter-skip",
      "name": "Filter Empty",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [690, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $vars.discord_webhook_url }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"embeds\": [{\n    \"title\": \"{{ $json.emoji }} {{ $json.status.toUpperCase() }}: {{ $json.alertname }}\",\n    \"description\": \"{{ $json.description }}\",\n    \"color\": {{ $json.color }},\n    \"fields\": [\n      {\n        \"name\": \"Severity\",\n        \"value\": \"{{ $json.severity }}\",\n        \"inline\": true\n      },\n      {\n        \"name\": \"Instance\",\n        \"value\": \"{{ $json.instance }}\",\n        \"inline\": true\n      },\n      {\n        \"name\": \"Job\",\n        \"value\": \"{{ $json.job }}\",\n        \"inline\": true\n      }\n    ],\n    \"timestamp\": \"{{ $json.timestamp }}\",\n    \"footer\": {\n      \"text\": \"Prometheus Alertmanager\"\n    }\n  }]\n}",
        "options": {}
      },
      "id": "discord-webhook",
      "name": "Send to Discord",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [910, 300]
    }
  ],
  "connections": {
    "Prometheus Webhook": {
      "main": [
        [
          {
            "node": "Parse Alerts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Alerts": {
      "main": [
        [
          {
            "node": "Filter Empty",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Empty": {
      "main": [
        [
          {
            "node": "Send to Discord",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": ["alerts", "prometheus", "discord"]
}
