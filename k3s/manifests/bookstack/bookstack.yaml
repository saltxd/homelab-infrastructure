---
# Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: bookstack
  labels:
    app.kubernetes.io/name: bookstack
---
# MySQL Credentials Secret
apiVersion: v1
kind: Secret
metadata:
  name: mysql-credentials
  namespace: bookstack
type: Opaque
stringData:
  mysql-root-password: "changeme"
  mysql-password: "changeme"
  mysql-user: "bookstack"
  mysql-database: "bookstack"
---
# MySQL Data PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-data
  namespace: bookstack
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
# BookStack Uploads PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: bookstack-uploads
  namespace: bookstack
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
# BookStack Config PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: bookstack-config
  namespace: bookstack
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
# MySQL Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: bookstack
  labels:
    app: mysql
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
        - name: mysql
          image: mysql:8.0
          ports:
            - containerPort: 3306
              name: mysql
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-credentials
                  key: mysql-root-password
            - name: MYSQL_DATABASE
              valueFrom:
                secretKeyRef:
                  name: mysql-credentials
                  key: mysql-database
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  name: mysql-credentials
                  key: mysql-user
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-credentials
                  key: mysql-password
          args:
            - --default-authentication-plugin=mysql_native_password
            - --character-set-server=utf8mb4
            - --collation-server=utf8mb4_unicode_ci
          volumeMounts:
            - name: mysql-data
              mountPath: /var/lib/mysql
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          livenessProbe:
            exec:
              command: ["mysqladmin", "ping", "-h", "localhost"]
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            exec:
              command: ["mysqladmin", "ping", "-h", "localhost"]
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: mysql-data
          persistentVolumeClaim:
            claimName: mysql-data
---
# MySQL Service
apiVersion: v1
kind: Service
metadata:
  name: mysql
  namespace: bookstack
spec:
  type: ClusterIP
  ports:
    - port: 3306
      targetPort: 3306
  selector:
    app: mysql
---
# BookStack Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bookstack
  namespace: bookstack
  labels:
    app: bookstack
spec:
  replicas: 1
  selector:
    matchLabels:
      app: bookstack
  template:
    metadata:
      labels:
        app: bookstack
    spec:
      initContainers:
        - name: wait-for-mysql
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for MySQL..."
              until nc -z mysql 3306; do
                sleep 3
              done
              echo "MySQL ready!"
      containers:
        - name: bookstack
          image: linuxserver/bookstack:latest
          ports:
            - containerPort: 80
              name: http
          env:
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
            - name: TZ
              value: "America/Denver"
            - name: APP_URL
              value: "http://docs.k3s.nox"
            - name: DB_HOST
              value: "mysql"
            - name: DB_PORT
              value: "3306"
            - name: DB_DATABASE
              valueFrom:
                secretKeyRef:
                  name: mysql-credentials
                  key: mysql-database
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mysql-credentials
                  key: mysql-user
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-credentials
                  key: mysql-password
            - name: APP_KEY
              value: "base64:GENERATE_A_NEW_APP_KEY"
          volumeMounts:
            - name: bookstack-config
              mountPath: /config
            - name: bookstack-uploads
              mountPath: /config/www/uploads
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          livenessProbe:
            httpGet:
              path: /login
              port: 80
            initialDelaySeconds: 120
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /login
              port: 80
            initialDelaySeconds: 60
            periodSeconds: 10
      volumes:
        - name: bookstack-config
          persistentVolumeClaim:
            claimName: bookstack-config
        - name: bookstack-uploads
          persistentVolumeClaim:
            claimName: bookstack-uploads
---
# BookStack Service
apiVersion: v1
kind: Service
metadata:
  name: bookstack
  namespace: bookstack
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 80
  selector:
    app: bookstack
---
# BookStack Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: bookstack
  namespace: bookstack
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web
spec:
  ingressClassName: traefik
  rules:
    - host: docs.k3s.nox
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: bookstack
                port:
                  number: 80
